<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHYS 42: AC Circuits Lab Calculator</title>
    <style>
        :root {
            /* Forced Dark/Green Theme */
            --primary-color: #66bb6a;
            --primary-color-dark: #388e3c;
            --primary-color-light: #2e2e2e;
            --secondary-color: #81c784;
            --text-color: #e0e0e0;
            --text-color-light: #bdbdbd;
            --background-color: #1c1c1c;
            --card-bg: #262626;
            --border-color: #424242;
            --error-color: #ef5350;
            --border-radius: 6px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            background-color: var(--background-color);
            color: var(--text-color);
            font-size: 16px;
            padding-bottom: 4rem;
        }

        /* Layout */
        header {
            background-color: var(--card-bg);
            border-bottom: 2px solid var(--primary-color);
            padding: 1.5rem 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        header h1 { color: var(--primary-color); font-size: 2rem; }
        header p { color: var(--text-color-light); }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Sections */
        section {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            /* Green outline effect */
            border-left: 4px solid var(--primary-color-dark);
        }

        section h2 {
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        h3 { color: var(--secondary-color); margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 1.1rem; }

        /* Formulas */
        .formula-box {
            background-color: rgba(129, 199, 132, 0.1);
            border: 1px dashed var(--primary-color-dark);
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        /* Tables */
        .table-wrapper { overflow-x: auto; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            min-width: 600px;
        }

        th, td {
            padding: 0.75rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--primary-color-light);
            color: var(--primary-color);
            font-weight: 600;
            white-space: nowrap;
        }

        /* Inputs */
        input[type="number"] {
            background-color: #333;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 4px;
            width: 100%;
            max-width: 120px;
            font-family: monospace;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(102, 187, 106, 0.2);
        }

        input[readonly] {
            background-color: transparent;
            border: none;
            color: var(--secondary-color);
            font-weight: bold;
            text-align: center;
        }

        /* Component Inputs */
        .component-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: var(--primary-color-light);
            border-radius: var(--border-radius);
        }

        .input-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .input-group label { font-size: 0.9rem; color: var(--text-color-light); font-weight: bold;}

        /* Utility Classes */
        .computed-val { color: var(--primary-color); font-weight: bold; }
        .diff-high { color: #ef5350; } /* Red for high diff */
        .diff-low { color: #ffa726; } /* Orange for warning */
        .diff-good { color: var(--primary-color); } /* Green for good */

        /* Buttons */
        .btn-group { display: flex; gap: 1rem; margin-top: 1rem; }
        
        .btn {
            background-color: var(--primary-color-dark);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        .btn:hover { opacity: 0.9; }
        
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color-dark);
            color: var(--primary-color);
        }

        footer { text-align: center; margin-top: 2rem; color: var(--text-color-light); font-size: 0.8rem;}
        
        /* Hide file input */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
</head>
<body>

    <header>
        <h1>PHYS 42 AC Circuits Lab</h1>
        <p>Data Entry & Automated Calculation Tool</p>
    </header>

    <div class="container">

        <section>
            <h2>Manage Data</h2>
            <p>Data saves automatically to your browser. Use buttons to save to file.</p>
            <div class="btn-group">
                <button id="btn-export" class="btn">Export JSON</button>
                <label class="btn btn-outline">
                    Import JSON
                    <input type="file" id="file-import" accept=".json" class="sr-only">
                </label>
                <button id="btn-clear" class="btn" style="background-color: #d32f2f;">Reset All</button>
            </div>
        </section>

        <section id="part1">
            <h2>Part 1: RC Circuit</h2>
            
            <div class="component-inputs">
                <div class="input-group">
                    <label>Measured R (Ω)</label>
                    <input type="number" id="p1_R" step="0.1" oninput="calcPart1()">
                </div>
                <div class="input-group">
                    <label>Measured C (µF)</label>
                    <input type="number" id="p1_C" step="0.01" oninput="calcPart1()">
                </div>
            </div>

            <div class="formula-box">
                Calculations:<br>
                I = V_R / R &nbsp;|&nbsp; X_C(comp) = V_C / I &nbsp;|&nbsp; X_C(theo) = 1 / (2πfC)<br>
                Phase(comp) = arctan(-X_C / R)
            </div>

            <h3>Table 1.1: Voltages & Current</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>V_supply (V)</th>
                            <th>V_R (V)</th>
                            <th>V_C (V)</th>
                            <th>I (A) [Calc]</th>
                        </tr>
                    </thead>
                    <tbody id="p1_table1">
                        <tr data-freq="1">
                            <td>1</td>
                            <td><input type="number" id="p1_1k_Vs" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_1k_Vr" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_1k_Vc" step="0.01" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_1k_I">--</td>
                        </tr>
                        <tr data-freq="2">
                            <td>2</td>
                            <td><input type="number" id="p1_2k_Vs" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_2k_Vr" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_2k_Vc" step="0.01" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_2k_I">--</td>
                        </tr>
                        <tr data-freq="3">
                            <td>3</td>
                            <td><input type="number" id="p1_3k_Vs" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_3k_Vr" step="0.01" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_3k_Vc" step="0.01" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_3k_I">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Table 1.2: Reactance (X_C)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>I (A)</th>
                            <th>X_C (Ω) Comp</th>
                            <th>X_C (Ω) Theo</th>
                            <th>% Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td id="p1_1k_I_copy">--</td>
                            <td class="computed-val" id="p1_1k_Xc_comp">--</td>
                            <td class="computed-val" id="p1_1k_Xc_theo">--</td>
                            <td id="p1_1k_Xc_diff">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td id="p1_2k_I_copy">--</td>
                            <td class="computed-val" id="p1_2k_Xc_comp">--</td>
                            <td class="computed-val" id="p1_2k_Xc_theo">--</td>
                            <td id="p1_2k_Xc_diff">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td id="p1_3k_I_copy">--</td>
                            <td class="computed-val" id="p1_3k_Xc_comp">--</td>
                            <td class="computed-val" id="p1_3k_Xc_theo">--</td>
                            <td id="p1_3k_Xc_diff">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Table 1.3: Phase Angle (ϕ)</h3>
            <div class="formula-box">
                Oscilloscope Calculation:<br>
                ϕ = (Δt / T) * 360<br>
                <em>Note: Enter T and Δt in the same units (e.g., both in divisions or both in seconds).</em>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>ϕ (deg) Comp</th>
                            <th>Period T (div or s)</th>
                            <th>Shift Δt (div or s)</th>
                            <th>ϕ (deg) Scope [Calc]</th>
                            <th>% Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td class="computed-val" id="p1_1k_phi_comp">--</td>
                            <td><input type="number" id="p1_1k_T" step="0.1" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_1k_dt" step="0.1" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_1k_phi_scope">--</td>
                            <td id="p1_1k_phi_diff">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td class="computed-val" id="p1_2k_phi_comp">--</td>
                            <td><input type="number" id="p1_2k_T" step="0.1" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_2k_dt" step="0.1" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_2k_phi_scope">--</td>
                            <td id="p1_2k_phi_diff">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td class="computed-val" id="p1_3k_phi_comp">--</td>
                            <td><input type="number" id="p1_3k_T" step="0.1" oninput="calcPart1()"></td>
                            <td><input type="number" id="p1_3k_dt" step="0.1" oninput="calcPart1()"></td>
                            <td class="computed-val" id="p1_3k_phi_scope">--</td>
                            <td id="p1_3k_phi_diff">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="part2">
            <h2>Part 2: RL Circuit</h2>
            
            <div class="component-inputs">
                <div class="input-group">
                    <label>Measured R (Ω)</label>
                    <input type="number" id="p2_R" step="0.1" oninput="calcPart2()">
                </div>
                <div class="input-group">
                    <label>Measured L (H)</label>
                    <input type="number" id="p2_L" step="0.001" oninput="calcPart2()">
                </div>
                <div class="input-group">
                    <label>Measured r (internal Ω)</label>
                    <input type="number" id="p2_r_int" step="0.1" oninput="calcPart2()">
                </div>
            </div>

            <div class="formula-box">
                Calculations:<br>
                V_r = I * r &nbsp;|&nbsp; V_coil = sqrt(V_L² - V_r²)<br>
                X_L(comp) = V_coil / I &nbsp;|&nbsp; X_L(theo) = 2πfL<br>
                Phase(comp) = arctan(X_L / R)
            </div>

            <h3>Table 2.1: Voltages & Internal Resistance</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>V_sup (V)</th>
                            <th>V_R (V)</th>
                            <th>V_L (V)</th>
                            <th>V_r (V) [Calc]</th>
                            <th>V_coil (V) [Calc]</th>
                            <th>I (A) [Calc]</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td><input type="number" id="p2_1k_Vs" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_1k_Vr" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_1k_Vl" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_1k_Vr_int">--</td>
                            <td class="computed-val" id="p2_1k_Vcoil">--</td>
                            <td class="computed-val" id="p2_1k_I">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td><input type="number" id="p2_2k_Vs" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_2k_Vr" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_2k_Vl" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_2k_Vr_int">--</td>
                            <td class="computed-val" id="p2_2k_Vcoil">--</td>
                            <td class="computed-val" id="p2_2k_I">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td><input type="number" id="p2_3k_Vs" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_3k_Vr" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_3k_Vl" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_3k_Vr_int">--</td>
                            <td class="computed-val" id="p2_3k_Vcoil">--</td>
                            <td class="computed-val" id="p2_3k_I">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Table 2.2: Reactance (X_L)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>X_L (Ω) Comp</th>
                            <th>X_L (Ω) Theo</th>
                            <th>% Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td class="computed-val" id="p2_1k_Xl_comp">--</td>
                            <td class="computed-val" id="p2_1k_Xl_theo">--</td>
                            <td id="p2_1k_Xl_diff">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td class="computed-val" id="p2_2k_Xl_comp">--</td>
                            <td class="computed-val" id="p2_2k_Xl_theo">--</td>
                            <td id="p2_2k_Xl_diff">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td class="computed-val" id="p2_3k_Xl_comp">--</td>
                            <td class="computed-val" id="p2_3k_Xl_theo">--</td>
                            <td id="p2_3k_Xl_diff">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <h3>Table 2.3: Phase Angle (ϕ)</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>f (kHz)</th>
                            <th>ϕ (deg) Comp</th>
                            <th>Period T (div or s)</th>
                            <th>Shift Δt (div or s)</th>
                            <th>ϕ (deg) Scope [Calc]</th>
                            <th>% Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>1</td>
                            <td class="computed-val" id="p2_1k_phi_comp">--</td>
                            <td><input type="number" id="p2_1k_T" step="0.1" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_1k_dt" step="0.1" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_1k_phi_scope">--</td>
                            <td id="p2_1k_phi_diff">--</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td class="computed-val" id="p2_2k_phi_comp">--</td>
                            <td><input type="number" id="p2_2k_phi_meas" step="1" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_2k_dt" step="0.1" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_2k_phi_scope">--</td>
                            <td id="p2_2k_phi_diff">--</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td class="computed-val" id="p2_3k_phi_comp">--</td>
                            <td><input type="number" id="p2_3k_T" step="0.1" oninput="calcPart2()"></td>
                            <td><input type="number" id="p2_3k_dt" step="0.1" oninput="calcPart2()"></td>
                            <td class="computed-val" id="p2_3k_phi_scope">--</td>
                            <td id="p2_3k_phi_diff">--</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="part3">
            <h2>Part 3: RLC Resonance</h2>
            
            <div class="formula-box">
                Calculation:<br>
                f_res = 1 / (2π * sqrt(L * C))<br>
                (Uses L and C from previous sections)
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                <div>
                    <h3>Frequency Sweep Data</h3>
                    <div class="table-wrapper" style="max-height: 400px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>f (Hz)</th>
                                    <th>V_R (V)</th>
                                </tr>
                            </thead>
                            <tbody id="p3_table">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3>Resonance Results</h3>
                    <div class="input-group" style="margin-bottom: 1rem;">
                        <label>Measured Peak Frequency (Hz)</label>
                        <input type="number" id="p3_f_meas" placeholder="Dial value" oninput="calcPart3()">
                    </div>
                    <div class="input-group" style="margin-bottom: 1rem;">
                        <label>Measured Max V_R (V)</label>
                        <input type="number" id="p3_Vr_max" placeholder="Max Voltage">
                    </div>

                    <div style="background-color: var(--primary-color-light); padding: 1rem; border-radius: 4px; border: 1px solid var(--border-color);">
                        <div style="margin-bottom: 0.5rem;">
                            <span>Computed Theoretical f_res:</span><br>
                            <strong class="computed-val" id="p3_f_theo" style="font-size: 1.5rem;">-- Hz</strong>
                        </div>
                        <div>
                            <span>Difference:</span><br>
                            <strong id="p3_diff">--</strong>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <footer>
        <p>PHYS 42 Lab Tool | Calculations accurate to sig fig inputs</p>
    </footer>

    <script>
        // --- Helper Functions ---
        function getVal(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            const v = parseFloat(el.value);
            return isNaN(v) ? null : v;
        }

        function setVal(id, val, units = "") {
            const el = document.getElementById(id);
            if (!el) return;
            if (val === null || isNaN(val) || !isFinite(val)) {
                el.innerText = "--";
                el.className = "computed-val";
            } else {
                el.innerText = val.toPrecision(4) + (units ? " " + units : "");
            }
        }

        function setDiff(id, percent) {
            const el = document.getElementById(id);
            if (!el) return;
            if (percent === null || isNaN(percent) || !isFinite(percent)) {
                el.innerText = "--";
                el.className = "";
                return;
            }
            el.innerText = percent.toFixed(2) + "%";
            if (Math.abs(percent) < 5) el.className = "diff-good";
            else if (Math.abs(percent) < 10) el.className = "diff-low";
            else el.className = "diff-high";
        }

        function calcDiff(meas, theo) {
            if (meas === null || theo === null) return null;
            return (Math.abs(Math.abs(meas) - Math.abs(theo)) / Math.abs(theo)) * 100;
        }

        // --- Part 3 Table Generator ---
        (function initPart3Table() {
            const tbody = document.getElementById('p3_table');
            for (let f = 200; f <= 3000; f += 200) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f}</td>
                    <td><input type="number" id="p3_f${f}_Vr" step="0.01"></td>
                `;
                tbody.appendChild(tr);
            }
        })();

        // --- CALCULATIONS ---

        function calcPart1() {
            const R = getVal('p1_R');
            const C_uF = getVal('p1_C');
            const C = C_uF ? C_uF * 1e-6 : null;

            const freqs = [1, 2, 3];

            freqs.forEach(f_kHz => {
                const f = f_kHz * 1000;
                const prefix = `p1_${f_kHz}k`;

                // Inputs
                const Vr = getVal(`${prefix}_Vr`);
                const Vc = getVal(`${prefix}_Vc`);
                
                // Scope Inputs
                const T = getVal(`${prefix}_T`);
                const dt = getVal(`${prefix}_dt`);

                // 1. Current
                let I = null;
                if (R && Vr) I = Vr / R;
                setVal(`${prefix}_I`, I);
                setVal(`${prefix}_I_copy`, I);

                // 2. Xc Computed
                let Xc_comp = null;
                if (Vc && I) Xc_comp = Vc / I;
                setVal(`${prefix}_Xc_comp`, Xc_comp);

                // 3. Xc Theo
                let Xc_theo = null;
                if (C) Xc_theo = 1 / (2 * Math.PI * f * C);
                setVal(`${prefix}_Xc_theo`, Xc_theo);

                // 4. Xc Diff
                setDiff(`${prefix}_Xc_diff`, calcDiff(Xc_comp, Xc_theo));

                // 5. Phase Computed
                let phi_comp = null;
                if (Xc_comp !== null && R) {
                    phi_comp = Math.atan(-Xc_comp / R) * (180 / Math.PI);
                }
                setVal(`${prefix}_phi_comp`, phi_comp);

                // 6. Phase Scope Calculation
                let phi_scope = null;
                if (T && dt) {
                    phi_scope = (dt / T) * 360;
                }
                setVal(`${prefix}_phi_scope`, phi_scope);

                // 7. Phase Diff
                setDiff(`${prefix}_phi_diff`, calcDiff(phi_scope, phi_comp));
            });

            saveData();
        }

        function calcPart2() {
            const R = getVal('p2_R');
            const L = getVal('p2_L');
            const r = getVal('p2_r_int');

            const freqs = [1, 2, 3];

            freqs.forEach(f_kHz => {
                const f = f_kHz * 1000;
                const prefix = `p2_${f_kHz}k`;

                const Vr = getVal(`${prefix}_Vr`);
                const Vl = getVal(`${prefix}_Vl`);
                
                // Scope Inputs
                const T = getVal(`${prefix}_T`);
                const dt = getVal(`${prefix}_dt`);

                // 1. Current
                let I = null;
                if (R && Vr) I = Vr / R;
                setVal(`${prefix}_I`, I);

                // 2. Vr_int
                let Vr_int = null;
                if (I && r) Vr_int = I * r;
                setVal(`${prefix}_Vr_int`, Vr_int);

                // 3. Vcoil
                let Vcoil = null;
                if (Vl !== null && Vr_int !== null) {
                    const term = (Vl * Vl) - (Vr_int * Vr_int);
                    Vcoil = term >= 0 ? Math.sqrt(term) : 0;
                }
                setVal(`${prefix}_Vcoil`, Vcoil);

                // 4. XL Comp
                let Xl_comp = null;
                if (Vcoil !== null && I > 0) Xl_comp = Vcoil / I;
                setVal(`${prefix}_Xl_comp`, Xl_comp);

                // 5. XL Theo
                let Xl_theo = null;
                if (L) Xl_theo = 2 * Math.PI * f * L;
                setVal(`${prefix}_Xl_theo`, Xl_theo);

                // 6. XL Diff
                setDiff(`${prefix}_Xl_diff`, calcDiff(Xl_comp, Xl_theo));

                // 7. Phase Comp
                let phi_comp = null;
                if (Xl_comp !== null && R) {
                    phi_comp = Math.atan(Xl_comp / R) * (180 / Math.PI);
                }
                setVal(`${prefix}_phi_comp`, phi_comp);

                // 8. Phase Scope Calc
                let phi_scope = null;
                if (T && dt) {
                    phi_scope = (dt / T) * 360;
                }
                setVal(`${prefix}_phi_scope`, phi_scope);

                // 9. Phase Diff
                setDiff(`${prefix}_phi_diff`, calcDiff(phi_scope, phi_comp));
            });

            saveData();
        }

        function calcPart3() {
            const L = getVal('p2_L');
            const C_uF = getVal('p1_C');
            const C = C_uF ? C_uF * 1e-6 : null;
            const f_meas = getVal('p3_f_meas');

            let f_theo = null;
            if (L && C) {
                f_theo = 1 / (2 * Math.PI * Math.sqrt(L * C));
            }
            setVal('p3_f_theo', f_theo);
            setDiff('p3_diff', calcDiff(f_meas, f_theo));
            saveData();
        }

        // --- DATA PERSISTENCE ---
        function saveData() {
            const inputs = document.querySelectorAll('input[type="number"]');
            const data = {};
            inputs.forEach(inp => {
                if (inp.id) data[inp.id] = inp.value;
            });
            localStorage.setItem('phys42LabData', JSON.stringify(data));
        }

        function loadData() {
            const stored = localStorage.getItem('phys42LabData');
            if (stored) {
                const data = JSON.parse(stored);
                for (const [id, val] of Object.entries(data)) {
                    const el = document.getElementById(id);
                    if (el) el.value = val;
                }
                calcPart1();
                calcPart2();
                calcPart3();
            }
        }

        // --- FILE EXPORT/IMPORT ---
        document.getElementById('btn-export').addEventListener('click', () => {
            const stored = localStorage.getItem('phys42LabData');
            if (!stored) return alert("No data to export!");
            const blob = new Blob([stored], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'phys42_lab_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        document.getElementById('file-import').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('phys42LabData', JSON.stringify(data));
                    loadData();
                } catch (err) {
                    alert("Invalid JSON file");
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            if(confirm("Clear all data?")) {
                localStorage.removeItem('phys42LabData');
                const inputs = document.querySelectorAll('input');
                inputs.forEach(i => i.value = '');
                calcPart1(); calcPart2(); calcPart3();
            }
        });

        window.addEventListener('DOMContentLoaded', loadData);

    </script>
</body>
</html>
